# 🌱 Supabase Seed Guide - Roadmap V4

Este guia explica como configurar e executar o script de seed do Supabase para popular a base de dados com dados de teste.

## 📋 Pré-requisitos

### 1. Configurar Projeto Supabase (Free Tier)

1. **Criar conta no Supabase**: https://supabase.com
2. **Criar novo projeto**:
   - Nome: `alfalyzer-dev` (ou outro nome)
   - Password: gerar senha segura
   - Região: escolher mais próxima

3. **Obter credenciais**:
   - Ir a `Settings` → `API`
   - Copiar:
     - `Project URL` (SUPABASE_URL)
     - `anon public` key (SUPABASE_ANON_KEY)
     - `service_role secret` key (SUPABASE_SERVICE_ROLE_KEY)

### 2. Configurar Variáveis de Ambiente

**Backend (.env):**
```bash
# Copiar de .env.example
cp .env.example .env

# Adicionar as credenciais do Supabase:
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_supabase_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key_here
```

**Frontend (.env.public):**
```bash
# Copiar de .env.public.example
cp .env.public.example .env.public

# Adicionar as credenciais públicas:
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key_here
VITE_API_BASE_URL=http://localhost:3001/api
```

### 3. Criar Tabelas no Supabase

Execute as migrations SQL no Supabase Dashboard → SQL Editor:

```sql
-- 1. Tabela de perfis (estende auth.users)
create table public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  updated_at timestamp with time zone,
  email text,
  display_name text,
  role text default 'user'::text,
  
  constraint profiles_email_key unique (email)
);

-- 2. Tabela de watchlists
create table public.watchlists (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users on delete cascade not null,
  name text not null,
  description text,
  is_public boolean default false
);

-- 3. Items das watchlists
create table public.watchlist_items (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  watchlist_id bigint references public.watchlists on delete cascade not null,
  symbol text not null,
  added_at timestamp with time zone default timezone('utc'::text, now()),
  notes text
);

-- 4. Tabela de portfolios
create table public.portfolios (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users on delete cascade not null,
  name text not null,
  description text,
  initial_value numeric default 0,
  current_value numeric default 0
);

-- 5. Posições dos portfolios
create table public.portfolio_positions (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  portfolio_id bigint references public.portfolios on delete cascade not null,
  symbol text not null,
  quantity numeric not null,
  average_price numeric not null,
  current_price numeric,
  purchased_at timestamp with time zone
);

-- 6. Tabela de transcripts
create table public.transcripts (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  ticker text not null,
  company_name text not null,
  quarter text not null,
  year integer not null,
  call_date date,
  raw_transcript text,
  ai_summary jsonb,
  status text default 'pending'::text,
  published_at timestamp with time zone,
  view_count integer default 0
);
```

### 4. Configurar Row Level Security (RLS)

Execute no SQL Editor:

```sql
-- Habilitar RLS em todas as tabelas
alter table public.profiles enable row level security;
alter table public.watchlists enable row level security;
alter table public.watchlist_items enable row level security;
alter table public.portfolios enable row level security;
alter table public.portfolio_positions enable row level security;
alter table public.transcripts enable row level security;

-- Políticas para profiles
create policy "Users can view own profile" on public.profiles
  for select using (auth.uid() = id);

create policy "Users can update own profile" on public.profiles
  for update using (auth.uid() = id);

-- Políticas para watchlists
create policy "Users can view own watchlists" on public.watchlists
  for select using (auth.uid() = user_id);

create policy "Users can create own watchlists" on public.watchlists
  for insert with check (auth.uid() = user_id);

create policy "Users can update own watchlists" on public.watchlists
  for update using (auth.uid() = user_id);

create policy "Users can delete own watchlists" on public.watchlists
  for delete using (auth.uid() = user_id);

-- Políticas para watchlist_items
create policy "Users can view own watchlist items" on public.watchlist_items
  for select using (auth.uid() in (
    select user_id from public.watchlists where id = watchlist_id
  ));

create policy "Users can manage own watchlist items" on public.watchlist_items
  for all using (auth.uid() in (
    select user_id from public.watchlists where id = watchlist_id
  ));

-- Políticas para portfolios
create policy "Users can view own portfolios" on public.portfolios
  for select using (auth.uid() = user_id);

create policy "Users can manage own portfolios" on public.portfolios
  for all using (auth.uid() = user_id);

-- Políticas para portfolio_positions
create policy "Users can view own positions" on public.portfolio_positions
  for select using (auth.uid() in (
    select user_id from public.portfolios where id = portfolio_id
  ));

create policy "Users can manage own positions" on public.portfolio_positions
  for all using (auth.uid() in (
    select user_id from public.portfolios where id = portfolio_id
  ));

-- Políticas para transcripts (público para leitura, admin para escrita)
create policy "Anyone can view published transcripts" on public.transcripts
  for select using (status = 'published');

-- Admin policies (adicionar depois quando implementar roles)
```

## 🚀 Executar Seed

### Comando Principal

```bash
npm run supabase:seed
```

### O que o Script Cria

1. **5 Utilizadores de Teste**:
   - `demo+1@alfalyzer.com` (admin) - Password: `Demo123!@#`
   - `demo+2@alfalyzer.com` (user) - Password: `Demo123!@#`
   - `demo+3@alfalyzer.com` (user) - Password: `Demo123!@#`
   - `demo+4@alfalyzer.com` (user) - Password: `Demo123!@#`
   - `demo+5@alfalyzer.com` (user) - Password: `Demo123!@#`

2. **Watchlists Aleatórias**:
   - Cada user recebe 1 watchlist com 5-10 stocks aleatórios
   - Stocks incluem: AAPL, MSFT, GOOGL, AMZN, TSLA, etc.

3. **Portfolios de Exemplo**:
   - Cada user recebe 1 portfolio com 3-6 posições
   - Valores e preços aleatórios realistas

4. **3 Transcripts de Exemplo**:
   - AAPL Q4 2024
   - MSFT Q4 2024  
   - GOOGL Q4 2024

## 🔧 Resolução de Problemas

### Erro: "Supabase configuration missing"

```bash
# Verificar se as variáveis estão definidas:
echo $SUPABASE_URL
echo $SUPABASE_SERVICE_ROLE_KEY

# Se não estiverem, adicionar ao .env:
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
```

### Erro: "Failed to connect to Supabase"

1. Verificar se o projeto Supabase está ativo
2. Confirmar credenciais no dashboard Supabase
3. Verificar se as tabelas foram criadas
4. Testar conectividade: `curl https://your-project.supabase.co/rest/v1/`

### Erro: "table 'profiles' does not exist"

Execute as queries SQL acima no Supabase SQL Editor para criar as tabelas.

### Erro: "Row Level Security"

Se receber erros de RLS, execute as políticas de segurança listadas acima.

## 📊 Verificar Dados Criados

### No Supabase Dashboard

1. Ir para `Table Editor`
2. Verificar as tabelas:
   - `auth.users` - 5 utilizadores
   - `profiles` - perfis dos utilizadores  
   - `watchlists` - listas criadas
   - `watchlist_items` - stocks nas listas
   - `portfolios` - portfolios criados
   - `portfolio_positions` - posições dos portfolios
   - `transcripts` - 3 transcripts de exemplo

### Via SQL

```sql
-- Contar utilizadores
select count(*) from auth.users;

-- Ver watchlists criadas
select w.name, w.user_id, count(wi.id) as items
from watchlists w
left join watchlist_items wi on w.id = wi.watchlist_id
group by w.id, w.name, w.user_id;

-- Ver portfolios criados
select p.name, p.user_id, count(pp.id) as positions
from portfolios p
left join portfolio_positions pp on p.id = pp.portfolio_id
group by p.id, p.name, p.user_id;

-- Ver transcripts
select ticker, company_name, status, view_count
from transcripts;
```

## 🧪 Testar Login

### Via Frontend

```javascript
// Login de teste no React
import { supabase } from '@/lib/supabase';

const testLogin = async () => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email: 'demo+1@alfalyzer.com',
    password: 'Demo123!@#'
  });
  
  if (error) {
    console.error('Login failed:', error);
  } else {
    console.log('Login successful:', data);
  }
};
```

### Via cURL (obter JWT)

```bash
curl -X POST 'https://your-project.supabase.co/auth/v1/token?grant_type=password' \
  -H "apikey: your_anon_key" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "demo+1@alfalyzer.com",
    "password": "Demo123!@#"
  }'
```

## 🔄 Re-executar Seed

O script pode ser executado múltiplas vezes. Ele tentará criar utilizadores e dados, mas falhará silenciosamente se já existirem (não duplicará).

Para limpar e recriar:

1. **Limpar utilizadores**: Supabase Dashboard → Authentication → Users → Deletar todos
2. **Limpar dados**: SQL Editor → `truncate table tablename cascade;`
3. **Re-executar**: `npm run supabase:seed`

## 📝 Próximos Passos

Após executar o seed com sucesso:

1. ✅ Testar login com utilizadores de teste
2. ✅ Verificar rotas protegidas (`/api/admin/**`, `/api/portfolio/**`, `/api/watchlist/**`)
3. ✅ Confirmar dados nas tabelas
4. ✅ Executar testes Playwright
5. ✅ Validar headers de rate limiting
6. ✅ Executar validação final

---

**✅ Seed configurado com sucesso quando:**
- 5 utilizadores criados
- Dados de teste populados
- Login funcional
- Rotas protegidas funcionais
- Sem erros no console